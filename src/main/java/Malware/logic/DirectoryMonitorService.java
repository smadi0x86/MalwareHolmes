package Malware.logic;

import java.io.IOException;
import java.nio.file.*;
import java.util.function.Predicate;

import Malware.logic.staticAnalysis.NativeWrapper;

public class DirectoryMonitorService implements Runnable {

    private final Path dir;
    private final MalwareAnalyzer malwareAnalyzer;
    private final Predicate<Path> filter;

    public DirectoryMonitorService(Path dir, MalwareAnalyzer malwareAnalyzer, Predicate<Path> filter) {
        this.dir = dir;
        this.malwareAnalyzer = malwareAnalyzer;
        this.filter = filter;
    }

    @Override
    public void run() {
        try (WatchService watcher = FileSystems.getDefault().newWatchService()) {
            dir.register(watcher, StandardWatchEventKinds.ENTRY_CREATE);

            System.out.println("[!] MalwareHolmes watching the folder: " + dir + "\n");

            while (true) {
                WatchKey key;
                try {
                    key = watcher.take();
                } catch (InterruptedException ex) {
                    return;
                }

                for (WatchEvent<?> event : key.pollEvents()) {
                    WatchEvent.Kind<?> kind = event.kind();

                    @SuppressWarnings("unchecked")
                    WatchEvent<Path> ev = (WatchEvent<Path>) event;
                    Path fileName = ev.context();

                    if (kind == StandardWatchEventKinds.ENTRY_CREATE && filter.test(fileName)) {
                        // a new file has been created and it passes the filter
                        System.out.println("[+] New file: " + fileName + " is created in the directory.\n");

                        // Run your malware analysis code here on the new file
                        analyzeFile(dir.resolve(fileName).toString());
                    }
                }

                boolean valid = key.reset();
                if (!valid) {
                    break;
                }
            }
        } catch (IOException e) {
            System.err.println("Exception occurred while monitoring directory: " + e.getMessage());
            e.printStackTrace();
        }
    }

    private void analyzeFile(String filePath) {
        try {
            // Check if the file is a PE/exe
            boolean isPEFile = isPEFile(filePath);

            // Start hash-based analysis
            String analysisResult = malwareAnalyzer.analyzeFile(filePath);
            System.out.println("Analysis hash result for your file: " + analysisResult + "\n");

            // Start static analysis if not a PE file
            if (!isPEFile) {
                NativeWrapper nativeWrapper = new NativeWrapper();
                nativeWrapper.analyze(filePath);
            } else {
                System.out.println("PE file detected. Consider running dynamic analysis on the file.");
                // Perform dynamic analysis or prompt the user to run dynamic analysis
                // You can implement the dynamic analysis logic here or prompt the user to perform it
            }

        } catch (IOException e) {
            System.err.println("Exception occurred during file analysis: " + e.getMessage());
            e.printStackTrace();
        } catch (Exception e) {
            System.err.println("Unexpected exception occurred: " + e.getMessage());
            e.printStackTrace();
        }
    }

    private boolean isPEFile(String filePath) {

        // Check if the file is a PE/exe
        try {
            byte[] fileBytes = Files.readAllBytes(Paths.get(filePath));

            // Check if the file is a PE/exe
            if (fileBytes[0] == 'M' && fileBytes[1] == 'Z') {
                return true;
            }
        } catch (IOException e) {
            System.err.println("Exception occurred while reading file: " + e.getMessage());
            e.printStackTrace();
        }
        return false;
    }
}