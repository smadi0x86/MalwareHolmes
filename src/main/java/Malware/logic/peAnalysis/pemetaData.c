#include "Malware_logic_peAnalysis_NativeWrapperPE.h"
#include <jni.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <windows.h>

JNIEXPORT jint JNICALL Java_Malware_logic_peAnalysis_NativeWrapperPE_pemetaData(JNIEnv *env, jobject obj, jstring filePath)
{
    const char *nativeString = (*env)->GetStringUTFChars(env, filePath, 0);

    // Open the file
    FILE *file = fopen(nativeString, "rb");
    if (file == NULL)
    {
        printf("Failed to open file: %s\n", nativeString);
        (*env)->ReleaseStringUTFChars(env, filePath, nativeString);
        return -1; // Return an error code
    }

    // Get the file size
    fseek(file, 0, SEEK_END);
    long fileSize = ftell(file);
    rewind(file);

    // Get image size
    DWORD imageSize;
    fseek(file, 0x3C, SEEK_SET); // PE header offset is at 0x3C
    fseek(file, 0x68, SEEK_CUR); // ImageSize is at offset 0x68 from PE header
    fread(&imageSize, 4, 1, file);

    // Get the timestamp
    DWORD timeStamp;
    fseek(file, -36, SEEK_CUR); // TimeStamp is at offset 0x4 from PE header
    fread(&timeStamp, 4, 1, file);

    // Get the file type
    WORD fileType;
    fseek(file, 20, SEEK_CUR); // Magic is at offset 0x18 from PE header
    fread(&fileType, 2, 1, file);

    fclose(file);

    // Get the file creation date
    WIN32_FIND_DATA fileData;
    HANDLE handle = FindFirstFile(nativeString, &fileData);
    if (handle == INVALID_HANDLE_VALUE)
    {
        printf("Failed to get file information: %s\n", nativeString);
        (*env)->ReleaseStringUTFChars(env, filePath, nativeString);
        return -1; // Return an error code
    }
    FILETIME creationTime = fileData.ftCreationTime;
    FindClose(handle);

    // Convert the FILETIME to a readable format
    SYSTEMTIME systemTime;
    FileTimeToSystemTime(&creationTime, &systemTime);
    char creationDate[100];
    sprintf(creationDate, "%02d-%02d-%04d %02d:%02d:%02d",
            systemTime.wDay, systemTime.wMonth, systemTime.wYear,
            systemTime.wHour, systemTime.wMinute, systemTime.wSecond);

    // Print the metadata
    printf("File Size: %ld bytes\n", fileSize);
    printf("Creation Date: %s\n", creationDate);
    printf("Loaded Image Size: %ld bytes\n", imageSize);
    double ratio = (double)fileSize / imageSize;
    printf("File Size / Image Size: %.2f\n", ratio);
    if (ratio < 0.7)
    {
        printf("Possible Packer: Yes\n");
    }
    else
    {
        printf("Possible Packer: No\n");
    }
    printf("Compilation Timestamp: %u\n", timeStamp);

    // Identify file type based on Magic value
    switch (fileType)
    {
    case 0x10b:
        printf("File Type: PE32\n");
        break;
    case 0x20b:
        printf("File Type: PE32+\n");
        break;
    default:
        printf("File Type: PE/exe\n");
    }

    (*env)->ReleaseStringUTFChars(env, filePath, nativeString);

    return 0;
}
