package Malware.logic;

import java.io.BufferedReader;
import java.io.InputStreamReader;
import java.io.PrintWriter;
import java.net.HttpURLConnection;
import java.net.URL;

public class SignatureIdentifier {

    private SignatureDatabase signatureDatabase;
    private String directoryPath;

    public SignatureIdentifier(SignatureDatabase signatureDatabase, String directoryPath) {
        this.signatureDatabase = signatureDatabase;
        this.directoryPath = directoryPath;
    }

    public void compareHash(String hash, String fileName) {
        String malwareName = signatureDatabase.getMalwareNameByHash(hash);

        if (malwareName != null && !malwareName.isEmpty()) {
            System.out.println("[WARNING] Calling FBI, It's a malware called: " + malwareName);
            QuarantineManager quarantineManager = new QuarantineManager("src/main/java/resources/quarantine");

            // Use the directoryPath field to get the full path of the file
            String fullPath = this.directoryPath + "\\" + fileName; // Change this line

            System.out.println("[INFO] Encrypting and moving file to quarantine...");
            quarantineManager.quarantineAndEncryptFile(fullPath, "infected");
        } else {
            System.out.println("[INFO] File not recognized as malware based on hash analysis.");
            System.out.println("[INFO] Calling MalwareBazaar API to check if it's a malware...");
            checkMalwareBazaar(hash);
        }
    }

    private void checkMalwareBazaar(String hash) {
        try {
            URL url = new URL("https://mb-api.abuse.ch/api/v1/"); // MalwareBazaar API URL
            HttpURLConnection con = (HttpURLConnection) url.openConnection();

            // Set up the connection to do output for a POST request, and disable caching
            con.setDoOutput(true);
            con.setRequestMethod("POST");
            con.setUseCaches(false);

            // Set the content type and build the form parameters
            con.setRequestProperty("Content-Type", "application/x-www-form-urlencoded");
            String urlParameters = "query=get_info&hash=" + hash;

            // Send the POST request
            con.getOutputStream().write(urlParameters.getBytes("UTF-8"));

            // Handle the response
            int responseCode = con.getResponseCode();

            if (responseCode == HttpURLConnection.HTTP_OK) { // success
                BufferedReader in = new BufferedReader(new InputStreamReader(con.getInputStream()));
                String inputLine;
                StringBuilder response = new StringBuilder();

                while ((inputLine = in.readLine()) != null) {
                    response.append(inputLine);
                }
                in.close();

                // Save the response to a JSON file based on the input hash
                String jsonFilePath = "src/main/java/resources/" + hash + ".json";
                PrintWriter out = new PrintWriter(jsonFilePath);
                out.println(response.toString());
                out.close();

                System.out.println("[INFO] Response from MalwareBazaar saved to: " + jsonFilePath);
            } else {
                System.out.println("[ERROR] POST request not worked, returned code: " + responseCode);
            }
        } catch (Exception e) {
            System.out.println("[ERROR] Error calling MalwareBazaar: " + e.getMessage());
            e.printStackTrace();
        }
    }
}
