/*
TODO: Implement hash table for faster lookup instead of array
TODO: Implement more static analysis techniques
TODO: Add logging to file instead of printing to console
*/
#include <stdio.h>
#include <string.h>
#include <sys/stat.h>
#include <time.h>
#include <jni.h>
#include "Malware_logic_staticAnalysis_NativeWrapper.h"

JNIEXPORT jint JNICALL Java_Malware_logic_staticAnalysis_NativeWrapper_analyze(JNIEnv *env, jobject obj, jstring filePath)
{
    const char *nativeFilePath = (*env)->GetStringUTFChars(env, filePath, 0);
    printf("[+] Running Static Analysis on %s\n", nativeFilePath);

    FILE *file = fopen(nativeFilePath, "rb");
    if (file == NULL)
    {
        printf("Failed to open file %s\n", nativeFilePath);
        (*env)->ReleaseStringUTFChars(env, filePath, nativeFilePath);
        return -1; // indicate error
    }

    struct stat fileStat;
    if (stat(nativeFilePath, &fileStat) != 0)
    {
        printf("Failed to get file status\n");
        fclose(file);
        (*env)->ReleaseStringUTFChars(env, filePath, nativeFilePath);
        return -1; // indicate error
    }

    char timeBuf[100];
    struct tm *tm_info;

    // Print the creation time
    tm_info = localtime(&fileStat.st_ctime);
    strftime(timeBuf, sizeof(timeBuf), "%Y-%m-%d %H:%M:%S", tm_info);
    printf("File creation time: %s\n", timeBuf);

    // Print the modification time
    tm_info = localtime(&fileStat.st_mtime);
    strftime(timeBuf, sizeof(timeBuf), "%Y-%m-%d %H:%M:%S", tm_info);
    printf("File modification time: %s\n", timeBuf);

    printf("File size: %lld bytes\n", (long long)fileStat.st_size);

    rewind(file); // rewind to the beginning for the next step

    char line[512]; // buffer for each line
    int result = 0; // default to 0 (no malware detected)

    // Array of strings to detect suspicious functions
    const char *susFunctions[] = {
        "OpenProcess",
        "CreateProcess",
        "CreateRemoteThread",
        "WriteProcessMemory",
        "ReadProcessMemory",
        "VirtualAllocEx",
        "VirtualProtectEx",
        "WinExec",
        "ShellExecute",
        "CreateThread",
        "CreateToolhelp32Snapshot",
        "Process32First",
        "Process32Next",
        "FindWindow",
        "FindWindowEx",
        "EnumWindows",
        "EnumChildWindows",
        "GetWindowText",
        "GetWindowTextLength",
        "GetModuleFileName"
        // TODO: add more functions
    };

    // Array of byte patterns to look for
    const char *susPatterns[] = {
        "0BADF00D",
        "DEADBEEF",
        "8BADF00D",
        "CAFEBABE",
        "BAADF00D",
        "BEEFCACE",
        "DEFACED1",
        "FACADE00",
        "FEEDFACE"
        // TODO: add more patterns
    };

    // Array of document-specific patterns (like JavaScript in PDF, macros in DOCX)
    const char *docPatterns[] = {
        "/JS ", // PDF JavaScript
        "/JavaScript ",
        "/AA ",         // PDF Auto Action
        "/OpenAction ", // PDF Open Action
        "/RichMedia ",  // PDF Embedded Flash
        "/Launch ",     // PDF Launch Actions
        "Auto_Open",    // Office Macros
        "AutoOpen",
        "Workbook_Open",
        "WorkbookOpen",
        "Document_Open",
        "DocumentOpen",
        "Shell()",
        "ShellExecute()"
        // TODO: add more patterns
    };

    while (fgets(line, sizeof(line), file))
    {
        for (int i = 0; i < sizeof(susFunctions) / sizeof(susFunctions[0]); i++)
        {
            if (strstr(line, susFunctions[i]) != NULL)
            {
                printf("Potential Malware Detected: %s function found!\n", susFunctions[i]);
                result = 1; // set result to 1 (malware detected)
            }
        }

        for (int i = 0; i < sizeof(susPatterns) / sizeof(susPatterns[0]); i++)
        {
            if (strstr(line, susPatterns[i]) != NULL)
            {
                printf("Potential Malware Detected: %s pattern found!\n", susPatterns[i]);
                result = 1; // set result to 1 (malware detected)
            }
        }

        for (int i = 0; i < sizeof(docPatterns) / sizeof(docPatterns[0]); i++)
        {
            if (strstr(line, docPatterns[i]) != NULL)
            {
                printf("Potential Malware Detected: %s pattern found!\n", docPatterns[i]);
                result = 1; // set result to 1 (malware detected)
            }
        }
    }

    fclose(file);
    (*env)->ReleaseStringUTFChars(env, filePath, nativeFilePath);
    return result;
}
